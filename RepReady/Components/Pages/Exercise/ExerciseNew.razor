@page "/exercise/new"
@rendermode InteractiveServer
@inject IHttpClientFactory HttpFactory
@inject NavigationManager Navigation
@inject ILogger<Exercise> Logger

<PageTitle>Create New Exercise</PageTitle>
<h1>Create New Exercise</h1>

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-danger" role="alert">
        @_errorMessage
    </div>
}

<ExerciseForm Model="@_newExercise" OnValidSubmit="HandleSubmit" IsSubmitting="@_isSubmitting" OnCancel="Cancel"/>

@code {
    [SupplyParameterFromQuery(Name = "bodyRegion")]
    public string? BodyRegion { get; set; }

    private ExerciseFormModel _newExercise = new();
    private bool _isSubmitting = false;
    private string _errorMessage = string.Empty;

    protected override void OnParametersSet()
    {
        // Prefill if coming from a region-specific page.
        if (!string.IsNullOrWhiteSpace(BodyRegion) && string.IsNullOrWhiteSpace(_newExercise.BodyRegion))
        {
            // Only set if it's a known region; otherwise ignore.
            if (Globals.BodyRegions.Contains(BodyRegion, StringComparer.OrdinalIgnoreCase))
            {
                _newExercise.BodyRegion = BodyRegion;
            }
        }
    }
    
    private async Task HandleSubmit()
    {
        _isSubmitting = true;
        _errorMessage = string.Empty;

        try
        {
            var exercise = new
            {
                name = _newExercise.Name,
                category = _newExercise.Category,
                bodyRegion = _newExercise.BodyRegion,
                createdAt = DateTime.UtcNow,
                updatedAt = DateTime.UtcNow,
            };

            using var http = HttpFactory.CreateClient("ApiClient");
            var response = await http.PostAsJsonAsync("/v1/exercises/", exercise);

            if (response.IsSuccessStatusCode)
            {
                Navigation.NavigateTo("/exercise");
            }
            else
            {
                _errorMessage = $"Failed to create exercise. Status: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error creating exercise: {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/exercise");
    }
}
